FROM alpine:3.6 AS builder
ARG BUILD_ROOT=/benchmark
ARG SQLITE_ROOT_HOST=dist/sqlite
ARG SQLITE_ROOT_IMAGE=${BUILD_ROOT}/sqlite
ARG BENCHMARK_LIB_ROOT_HOST=benchmark
ARG BENCHMARK_LIB_ROOT_IMAGE=${BUILD_ROOT}/benchmark_lib
ARG BENCHMARK_EXE_ROOT_HOST=benchmark-sgx/src
ARG BENCHMARK_EXE_ROOT_IMAGE=${BUILD_ROOT}
ARG INSTRUMENTATION_HOST=instrumentation-callbacks
ARG INSTRUMENTATION_IMAGE=${BUILD_ROOT}/instrumentation-callbacks
ARG INSTRUMENTATION_CALLBACKS=timing_callbacks

RUN apk add --no-cache gcc musl-dev

RUN mkdir ${BUILD_ROOT}

ADD ${SQLITE_ROOT_HOST} ${SQLITE_ROOT_IMAGE}
ADD ${BENCHMARK_LIB_ROOT_HOST}/include ${BENCHMARK_LIB_ROOT_IMAGE}/include
ADD ${BENCHMARK_LIB_ROOT_HOST}/src ${BENCHMARK_LIB_ROOT_IMAGE}/src
ADD ${BENCHMARK_EXE_ROOT_HOST} ${BENCHMARK_EXE_ROOT_IMAGE}
ADD ${INSTRUMENTATION_HOST} ${INSTRUMENTATION_IMAGE}
RUN gcc \
    -g \
    -I${SQLITE_ROOT_IMAGE} \
    -I${BENCHMARK_LIB_ROOT_IMAGE}/include \
    -I${INSTRUMENTATION_IMAGE}/include \
    -DSQLITE_OS_OTHER \
    -DSQLITE_ENABLE_MEMSYS3 \
    -o ${BUILD_ROOT}/app \
    -O3 \
    ${SQLITE_ROOT_IMAGE}/*.c ${BENCHMARK_LIB_ROOT_IMAGE}/src/*.c ${BENCHMARK_EXE_ROOT_IMAGE}/*.c ${INSTRUMENTATION_IMAGE}/src/${INSTRUMENTATION_CALLBACKS}.c


FROM alpine:3.6
ARG BUILD_ROOT=/benchmark

COPY --from=builder ${BUILD_ROOT}/app .